name: Create new release v2
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"  # Weekly on Sundays
    
jobs:
  check-for-changes:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      latest_release: ${{ steps.latestRelease.outputs.release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-tags: true
          fetch-depth: 0

      - id: latestRelease
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ${{ github.repository }}
          excludes: prerelease, draft
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for commits since last release
        id: check
        run: |
          COMMITS=$(git rev-list ${{ steps.latestRelease.outputs.release }}..HEAD --count 2>/dev/null || echo "999")
          echo "Commits since last release: $COMMITS"
          if [ "$COMMITS" -gt "0" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  publish:
    runs-on: ubuntu-latest
    needs: check-for-changes
    if: needs.check-for-changes.outputs.has_changes == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-tags: true
          fetch-depth: 0
          clean: true

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "adopt"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Get Next Version
        id: nextSemver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ github.token }}
          branch: master
          patchList: build, fix, bugfix, perf, refactor, test, tests, deps, dependencies
          fallbackTag: ${{ needs.check-for-changes.outputs.latest_release }}

      - name: Update release in gradle.properties
        run: |
          sed -i "s/^version.*/version=${{ steps.nextSemver.outputs.nextStrict }}/g" gradle.properties

      - name: Publish package
        run: ./gradlew publish
        env:
          GH_USERNAME: ${{ github.actor }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        id: create-release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.nextSemver.outputs.nextStrict }}
          name: quartz-mongodb ${{ steps.nextSemver.outputs.next }}
          draft: false
          body: |
            Maven Usage:
              ```
              <dependency>
                <groupId>io.github.avi-sanwal</groupId>
                <artifactId>quartz-mongodb</artifactId>
                <version>${{ steps.nextSemver.outputs.nextStrict }}</version>
              </dependency>
              ```
            Gradle Usage:
              `implementation("io.github.avi-sanwal:quartz-mongodb:${{ steps.nextSemver.outputs.nextStrict }}")`
          generate_release_notes: true
          files: |
            build/libs/quartz-mongodb-${{ steps.nextSemver.outputs.nextStrict }}.jar
            build/libs/quartz-mongodb-${{ steps.nextSemver.outputs.nextStrict }}-sources.jar
            build/libs/quartz-mongodb-${{ steps.nextSemver.outputs.nextStrict }}-javadoc.jar
